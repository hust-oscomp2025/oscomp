# 进程文件系统信息对象 `struct fs_struct`

定义在`include/kernel/fs/fs_struct.h`

## 核心功能与职责

`struct fs_struct` 维护进程的文件系统上下文信息，主要功能包括：

1. **目录上下文管理**：
   - 跟踪进程的根目录和当前工作目录
   - 为相对路径解析提供基准点
   - 支持 chroot 和 chdir 等操作

2. **命名空间隔离**：
   - 关联进程到特定的挂载命名空间
   - 支持容器化和文件系统视图隔离
   - 定义进程可见的文件系统层次结构

3. **进程标识与安全**：
   - 影响进程文件访问权限边界
   - 定义进程可访问文件的范围
   - 提供文件系统操作的上下文环境

4. **共享控制**：
   - 允许相关进程共享文件系统视图
   - 支持 fork() 过程中的文件系统信息继承
   - 管理进程间的目录上下文共享

## 成员变量解析

### 1. `root`（根目录）
- **功能**：
  - 定义进程的根目录视图
  - 限制进程文件系统访问的顶层边界
  - 支持 chroot 环境和安全隔离
- **关联组件**：
  - **路径解析系统**：为绝对路径解析提供起点
  - **安全子系统**：提供文件系统访问隔离

### 2. `pwd`（当前工作目录）
- **功能**：
  - 记录进程的当前工作目录
  - 为相对路径解析提供参考点
  - 支持应用程序的文件操作上下文
- **关联组件**：
  - **路径解析系统**：处理相对路径的基准点
  - **系统调用**：支持 getcwd()、chdir() 等操作

### 3. `mnt_ns`（挂载命名空间）
- **功能**：
  - 指向进程的挂载命名空间
  - 定义可见的文件系统集合和挂载点
  - 支持文件系统视图隔离
- **关联组件**：
  - **命名空间管理**：处理进程的资源视图隔离
  - **VFS挂载系统**：控制可见的文件系统挂载点

### 4. `lock`（自旋锁）
- **功能**：
  - 保护 pwd 和 root 成员免受并发访问
  - 同步多线程对目录上下文的修改
  - 防止竞争条件
- **关联组件**：
  - **并发控制**：防止多线程修改冲突
  - **调度器**：在锁持有期间禁用抢占

### 5. `count`（引用计数）
- **功能**：
  - 追踪此结构的使用情况
  - 控制结构的生命周期
  - 支持多个相关进程共享同一结构
- **关联组件**：
  - **内存管理**：确定何时安全释放结构
  - **进程管理**：在 fork/exit 时管理引用

## 初始化流程

进程文件系统信息对象的典型初始化流程是：

1. 通过 `setup_fs_struct()` 创建新实例，可能在进程创建时
2. 初始化 `root` 指向根文件系统的根目录
3. 初始化 `pwd` 指向与 `root` 相同的位置（或指定目录）
4. 设置 `mnt_ns` 指向进程的挂载命名空间（新建或继承）
5. 初始化 `lock` 自旋锁
6. 设置 `count` 为初始引用计数（通常为 1）

## 系统交互

`struct fs_struct` 与以下系统组件进行交互：

1. **进程管理**：
   - 在进程创建时初始化文件系统上下文
   - fork() 操作会复制或共享此结构
   - exit() 时减少引用计数并可能释放

2. **路径解析**：
   - 提供所有文件系统操作的上下文
   - 定义绝对路径和相对路径的解析起点
   - 影响所有文件访问操作的可见性

3. **挂载管理**：
   - 通过 mnt_ns 关联到可见的挂载点集合
   - 改变进程的文件系统视图
   - 支持文件系统隔离和容器技术

4. **安全子系统**：
   - 通过 root 限制文件系统访问范围
   - 实现 chroot 等安全机制
   - 防止进程访问授权范围外的文件

## 生命周期与并发控制

1. **创建**：
   - 进程初始化时通过 `setup_fs_struct()` 创建
   - fork() 时通过 `copy_fs_struct()` 复制自父进程

2. **共享与并发**：
   - 线程通常共享同一个 fs_struct
   - 使用 lock 自旋锁保护并发访问
   - 通过原子引用计数管理共享关系

3. **修改**：
   - chdir() 系统调用修改 pwd 成员
   - chroot() 系统调用修改 root 成员
   - 这些修改受 lock 保护

4. **销毁**：
   - 当引用计数降至零时释放
   - 通过 `put_fs_struct()` 减少引用并可能触发销毁
   - 进程结束时会减少其 fs_struct 的引用

## 特殊机制

1. **目录切换**：
   - 通过 `set_fs_pwd()` 更改当前工作目录
   - 处理符号链接的特殊情况
   - 验证目录访问权限

2. **根目录更改**：
   - 通过 `set_fs_root()` 实现 chroot 功能
   - 需要特权权限执行
   - 创建文件系统沙箱环境

3. **命名空间交互**：
   - 支持挂载命名空间的切换
   - 允许进程查看不同的文件系统视图
   - 与容器技术密切相关

4. **权限检查**：
   - 结合进程凭证进行访问控制
   - 影响所有文件系统操作的权限评估
   - 实现最小权限原则

5. **路径解析上下文**：
   - 为所有文件操作提供基准点
   - 影响相对路径和绝对路径的解析行为
   - 确保路径解析的一致性和安全性