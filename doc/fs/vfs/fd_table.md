# 进程文件描述符表 `fd_table`

定义在`include/kernel/fs/file.h`

##  核心功能与职责

`fd_table` 负责管理进程打开的所有文件描述符，主要功能包括：

1. **文件描述符管理**：
   - 维护 `fd_array`（文件指针数组）和 `fd_flags`（描述符标志）
   - 追踪最大描述符数 `max_fds` 和下一个可用描述符 `next_fd`
   - 为每个打开的文件分配整数句柄

2. **描述符分配与释放**：
   - 通过 `alloc_fd()` 分配新的文件描述符
   - 当文件关闭时释放描述符

## 系统交互

`fd_table` 与以下系统组件进行交互：

1. **进程控制块 (task_struct)**：
   -  `fd_table` 结构体与进程一一对应。
   - `fork` 时会复制其内容，同时增加 `struct file*` 的引用计数
   - 通过 `get_files_struct()` 获取进程的文件表

2. **文件对象 (struct file)**：
   - `fd_array` 存储指向 `struct file` 实例的指针
   - 文件对象连接到具体的文件系统实现

3. **系统调用**：
   - `open()`、`read()`、`write()`、`close()` 等系统调用都会操作文件描述符表
   - 系统调用使用文件描述符号查找对应的文件对象

## 生命周期与并发控制

`fd_table` 实现了完整的并发控制机制：

1. **创建**：
   - 进程初始化时通过 `init_files()` 创建，`fork()` 时会复制父进程的描述符表
   - 通常默认包含标准输入(0)、输出(1)、错误(2)描述符

2. **共享与并发**：
   - 线程间共享同一个 `fd_table`
   - `unshare_files()` 可创建共享表的私有副本(我们没有这个特性)

3. **销毁**：
   - 当最后一个引用被释放时（通过 `put_files_struct()` 释放引用）
   - 进程终止时描述符表会被清理，所有打开的文件会被关闭

## 特殊机制

1. **文件描述符继承**：
   - 子进程默认继承父进程的文件描述符
   - 父子进程指向相同的文件对象（引用计数增加）

2. **执行时关闭 (O_CLOEXEC)**：
   - 描述符可标记为执行新程序时自动关闭
   - 通过 `fd_flags` 数组维护此标志（相当于为每个fd分配一个字段当flags）

3. **资源限制**：
   - 系统对每个进程的打开文件数有限制
   - 这直接约束了 `fd_table` 的大小