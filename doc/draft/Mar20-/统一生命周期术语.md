åœ¨å†…æ ¸è®¾è®¡ä¸­ï¼Œ**å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„æœ¯è¯­ç»Ÿä¸€æ€§**éå¸¸é‡è¦ï¼Œå¦åˆ™ä¼šå¯¼è‡´ä»£ç å¯è¯»æ€§é™ä½ï¼Œç»´æŠ¤å˜å¾—å›°éš¾ã€‚ä½ çš„é—®é¢˜æ˜¯ **`alloc`ã€`get`ã€`create`ã€`grab`ã€`setup`ã€`free`ã€`put` ç­‰åŠ¨è¯æ··ç”¨ï¼Œå¦‚ä½•ç»Ÿä¸€æ ‡å‡†ï¼Ÿ**

---

## **1. ä¸šç•Œå¸¸è§çš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ¯è¯­**
åœ¨ Linux å†…æ ¸ã€BSDã€LLVM å’Œå…¶ä»–å¤§å‹é¡¹ç›®ä¸­ï¼Œé€šå¸¸ä¼šé‡‡ç”¨**ä¸€å¥—æ ‡å‡†çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å‘½å**ï¼Œä¸»è¦åŒºåˆ†ï¼š
- **å¯¹è±¡çš„åˆ›å»º**
- **å¯¹è±¡çš„è·å–**
- **å¯¹è±¡çš„é‡Šæ”¾**
- **å¯¹è±¡çš„å¼•ç”¨è®¡æ•°**

### **å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„æ ‡å‡†æµç¨‹**
```
allocate -> initialize -> acquire -> use -> release -> free
```
å¯¹åº”çš„å‡½æ•°å‘½åå»ºè®®ï¼š
| **é˜¶æ®µ**       | **åŠŸèƒ½** | **æ¨èåŠ¨è¯**  | **è§£é‡Š** |
|--------------|---------|------------|----------|
| **åˆ†é…å¯¹è±¡** | ç”³è¯·å†…å­˜å¹¶è¿”å›æŒ‡é’ˆ | `alloc`  | ä»…åˆ†é…å†…å­˜ï¼Œä½†ä¸åˆå§‹åŒ– |
| **åˆ›å»ºå¯¹è±¡** | åˆ†é…å¹¶åˆå§‹åŒ– | `create` | `alloc + setup`ï¼Œåˆ›å»ºå®Œæ•´å¯¹è±¡ |
| **åˆå§‹åŒ–å¯¹è±¡** | ä»…åˆå§‹åŒ–å·²åˆ†é…å¯¹è±¡ | `init`   | ä¼ å…¥å·²åˆ†é…å†…å­˜ï¼Œè¿›è¡Œåˆå§‹åŒ– |
| **è·å–å¯¹è±¡** | å¢åŠ å¼•ç”¨è®¡æ•° | `get`    | é€‚ç”¨äºå¼•ç”¨è®¡æ•°å¯¹è±¡ |
| **æŒæœ‰å¯¹è±¡** | æš‚æ—¶è·å–ï¼Œä¸å½±å“ç”Ÿå‘½å‘¨æœŸ | `grab`   | ä»…æš‚å­˜ï¼Œä¸å¢åŠ å¼•ç”¨è®¡æ•° |
| **ä½¿ç”¨å¯¹è±¡** | è®¾ç½®å‚æ•° | `setup`  | é¢å¤–é…ç½®å¯¹è±¡ï¼Œä¸å½±å“ç”Ÿå‘½å‘¨æœŸ |
| **é‡Šæ”¾å¯¹è±¡** | å‡å°‘å¼•ç”¨è®¡æ•° | `put`    | ä»…å‡å°‘å¼•ç”¨è®¡æ•°ï¼Œä¸çœŸæ­£é‡Šæ”¾ |
| **é”€æ¯å¯¹è±¡** | åˆ é™¤å¯¹è±¡ | `destroy` | ä½¿å¯¹è±¡å¤±æ•ˆï¼Œæ‰§è¡Œ `free` |
| **é‡Šæ”¾å†…å­˜** | é‡Šæ”¾å¯¹è±¡ | `free`    | é‡Šæ”¾åˆ†é…çš„å†…å­˜ |

---

## **2. å¦‚ä½•åº”ç”¨åˆ°ä½ çš„å†…æ ¸ï¼Ÿ**
ä½ å¯ä»¥ä¸º **ä¸åŒç±»å‹çš„å¯¹è±¡** é‡‡ç”¨è¿™å¥—å‘½åè§„åˆ™ï¼š

### **ï¼ˆ1ï¼‰å¦‚æœå¯¹è±¡æ˜¯**åŠ¨æ€åˆ†é…çš„**ï¼ˆå¦‚ `struct task`ã€`struct file` ç­‰ï¼‰**
| **åŠŸèƒ½** | **æ ‡å‡†å‘½å** | **è§£é‡Š** |
|---------|-----------|---------|
| **åˆ†é…å†…å­˜** | `task_alloc()` | ä»…åˆ†é… `struct task` å†…å­˜ |
| **åˆå§‹åŒ–å¯¹è±¡** | `task_init()` | ä¼ å…¥ `struct task *`ï¼Œåˆå§‹åŒ– |
| **åˆ›å»ºå¯¹è±¡** | `task_create()` | `task_alloc()` + `task_init()` |
| **å¢åŠ å¼•ç”¨è®¡æ•°** | `task_get()` | å¢åŠ  `refcount`ï¼Œä¸ä¼šæ–°å»ºå¯¹è±¡ |
| **å‡å°‘å¼•ç”¨è®¡æ•°** | `task_put()` | å‡å°‘ `refcount`ï¼Œåˆ° 0 æ—¶é‡Šæ”¾ |
| **é‡Šæ”¾å¯¹è±¡** | `task_free()` | é‡Šæ”¾ `struct task` å†…å­˜ |

**ç¤ºä¾‹**
```c
struct task *task_create() {
    struct task *t = task_alloc();
    if (!t) return NULL;
    task_init(t);
    return t;
}
```

---

### **ï¼ˆ2ï¼‰å¦‚æœå¯¹è±¡æ˜¯é™æ€çš„ï¼ˆå¦‚ `static struct`ï¼‰**
| **åŠŸèƒ½** | **æ ‡å‡†å‘½å** | **è§£é‡Š** |
|---------|-----------|---------|
| **åˆå§‹åŒ–** | `buffer_setup()` | ä»…è®¾ç½®å‚æ•°ï¼Œä¸æ–°å»ºå¯¹è±¡ |
| **æ¸…ç†** | `buffer_destroy()` | é‡Šæ”¾èµ„æºï¼Œä½†ä¸ `free` |

**ç¤ºä¾‹**
```c
void buffer_setup(struct buffer *buf, int size);
void buffer_destroy(struct buffer *buf);
```

---

### **ï¼ˆ3ï¼‰å¦‚æœå¯¹è±¡æ¶‰åŠå¼•ç”¨è®¡æ•°ï¼ˆå¦‚ `inode`ã€`dentry`ï¼‰**
| **åŠŸèƒ½** | **æ ‡å‡†å‘½å** | **è§£é‡Š** |
|---------|-----------|---------|
| **è·å–å¯¹è±¡ï¼ˆå¢åŠ  refï¼‰** | `inode_get()` | `ref++` |
| **é‡Šæ”¾å¯¹è±¡ï¼ˆå‡å°‘ refï¼‰** | `inode_put()` | `ref--`ï¼Œåˆ° 0 æ—¶é‡Šæ”¾ |

**ç¤ºä¾‹**
```c
struct inode *inode_get(struct inode *inode) {
    atomic_inc(&inode->refcount);
    return inode;
}

void inode_put(struct inode *inode) {
    if (atomic_dec_and_test(&inode->refcount))
        inode_free(inode);
}
```

---

## **3. ä½ çš„å†…æ ¸è®¾è®¡åº”è¯¥é‡‡ç”¨çš„æ ‡å‡†**
ä½ å¯ä»¥é€‰æ‹©ä»¥ä¸‹å‘½åæ–¹æ¡ˆï¼š
1. **å¦‚æœå¯¹è±¡æ˜¯åŠ¨æ€åˆ†é…çš„**
   - `alloc` / `free` å¤„ç†å†…å­˜
   - `init` / `destroy` å¤„ç†èµ„æº
   - `create` è¿›è¡Œå®Œæ•´çš„å¯¹è±¡åˆ›å»º

2. **å¦‚æœå¯¹è±¡æ˜¯å¼•ç”¨è®¡æ•°çš„**
   - `get` å¢åŠ å¼•ç”¨
   - `put` é‡Šæ”¾å¼•ç”¨

3. **å¦‚æœå¯¹è±¡ä¸æ¶‰åŠç”Ÿå‘½å‘¨æœŸ**
   - `setup` ç”¨äºé…ç½®
   - `reset` / `clear` ç”¨äºé‡ç½®

---

## **4. ä½ çš„ç°æœ‰å‘½åå¦‚ä½•æ˜ å°„åˆ°ç»Ÿä¸€æ ‡å‡†ï¼Ÿ**
ä½ çš„ç°æœ‰æœ¯è¯­ï¼š
| **æ—§å‘½å** | **ç»Ÿä¸€åçš„å‘½å** | **è§£é‡Š** |
|----------|-----------------|---------|
| `alloc_*` | âœ… **`alloc_*`** | ä»…åˆ†é…å†…å­˜ï¼Œä¸åˆå§‹åŒ– |
| `create_*` | âœ… **`create_*`** | `alloc + init` |
| `get_*` | âœ… **`get_*`** | å¢åŠ å¼•ç”¨è®¡æ•° |
| `grab_*` | âŒ **å¼ƒç”¨ï¼Œæ”¹ç”¨ `get_*`** | `get_*` ç»Ÿä¸€ |
| `setup_*` | âœ… **`setup_*`** | ä»…é…ç½®å¯¹è±¡ï¼Œä¸åˆ›å»º |
| `free_*` | âœ… **`free_*`** | é‡Šæ”¾å†…å­˜ |
| `put_*` | âœ… **`put_*`** | é‡Šæ”¾å¼•ç”¨è®¡æ•° |
| `destroy_*` | âœ… **`destroy_*`** | æ¸…ç†å¯¹è±¡ï¼ˆé `free`ï¼‰ |

ğŸ”¹ **ç»“è®º**ï¼š
- `alloc_*` åªç”¨äºåˆ†é…
- `create_*` ç”¨äºå®Œæ•´å¯¹è±¡åˆ›å»º
- `get_*` / `put_*` å¤„ç†å¼•ç”¨
- `setup_*` ç”¨äºé…ç½®
- `destroy_*` / `free_*` å¤„ç†é”€æ¯

---

## **5. ç»Ÿä¸€åï¼Œç¤ºä¾‹ä»£ç **
```c
// å¯¹è±¡åˆ›å»º
struct task *task_create() {
    struct task *t = task_alloc();
    if (!t) return NULL;
    task_init(t);
    return t;
}

// å¼•ç”¨ç®¡ç†
struct task *task_get(struct task *t) {
    atomic_inc(&t->refcount);
    return t;
}

void task_put(struct task *t) {
    if (atomic_dec_and_test(&t->refcount))
        task_free(t);
}

// é‡Šæ”¾å¯¹è±¡
void task_free(struct task *t) {
    kfree(t);
}
```

---

## **6. ç»“è®º**
âœ… é‡‡ç”¨ç»Ÿä¸€æ ‡å‡†ï¼š
- `alloc/free`ï¼šä»…ç®¡ç†å†…å­˜
- `create/destroy`ï¼šåˆ›å»ºå’Œé”€æ¯å®Œæ•´å¯¹è±¡
- `get/put`ï¼šç®¡ç†å¼•ç”¨è®¡æ•°
- `setup`ï¼šä»…é…ç½®å¯¹è±¡

ä½ çš„å†…æ ¸ä»£ç é£æ ¼ä¼šæ›´åŠ ä¸€è‡´ã€å¯è¯»æ€§æ›´å¼ºï¼ŒåŒæ—¶ä¹Ÿä¸ Linux ä¹ æƒ¯æ›´æ¥è¿‘ï¼ğŸš€